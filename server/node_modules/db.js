var dbConfig = require('../../config.js').db
var Promise = require('promise')
var mysql = require('mysql')

var pool = mysql.createPool(dbConfig)

var queryReturningPromise = Promise.denodeify(pool.query.bind(pool))

var promiseWrapper = Object.create(pool)
promiseWrapper.query = function executeQuery(query) {
	if (query && query.str && query.params) {
		return queryReturningPromise(query.str, query.params)
	} else if (query && typeof query.build === 'function'){
		return executeQuery(query.build())
	} else {
		return queryReturningPromise.apply(null, arguments)
	}
}

module.exports = function getDbPool() {
	return promiseWrapper
}
